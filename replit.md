# Mandi Mitra - Agricultural Marketplace Manager

## Overview
Mandi Mitra is a multi-tenant agricultural commodity trading management system that handles end-to-end processes from stock entry to billing. It covers farmer onboarding, lot management, bidding, transactions, cash management, and ledger tracking. The system admin (app owner) can onboard businesses and users through an Admin Panel.

## Architecture
- **Frontend**: React + TypeScript with Tailwind CSS and Shadcn UI components
- **Backend**: Express.js REST API with session-based authentication (Passport.js)
- **Database**: PostgreSQL with Drizzle ORM
- **Multi-Tenant**: Data isolation via `businessId` foreign key on all tables

## User Roles
- **system_admin**: App owner, accesses Admin Panel to manage businesses and users
- **user**: Business user, accesses Mandi Mitra trading app (stock entry, bidding, etc.)

## Key Features
1. **Admin Panel** - System admin manages merchants (businesses) and users
   - Merchants: Add, edit, activate/deactivate, archive, reset (wipe user data)
   - Users: Add, edit, reset password, delete
   - Business status controls: inactive/archived prevents user login
   - Merchant ID format: BU + YYYYMMDD + sequence (e.g., BU202602131)
   - Default user password: password123
2. **Stock Entry** - Register farmers and create lots with auto-generated Lot IDs (POT/ONI/GAR prefix + YYYYMMDD + sequence)
3. **Stock Register** - View all lots with card layout, crop toggle, search/filter, edit capability
4. **Bidding** - Multiple buyers can bid on available lots, grade selection (Large/Medium, Small, Chhatan)
5. **Transactions** - Calculate net weight, commissions (aadhat + mandi), payable/receivable amounts
6. **Cash Management** - Track Cash In (from buyers) and Cash Out (to farmers) with payment modes
7. **Farmer Ledger** - Opening balance, transactions, payments, current dues
8. **Buyer Ledger** - Same structure for buyer tracking

## Project Structure
```
shared/schema.ts       - Database schema, types, and validation schemas
server/
  index.ts             - Express server setup
  db.ts                - PostgreSQL connection pool
  auth.ts              - Passport.js authentication (requireAuth, requireAdmin)
  routes.ts            - All API routes (admin + user)
  storage.ts           - Database storage interface
client/src/
  App.tsx              - Main app with routing and responsive layout
  lib/auth.tsx         - Auth context provider
  pages/
    login.tsx          - Login page
    change-password.tsx - First-time password change (requires mobile + new password)
    admin.tsx          - Admin panel (merchants + users tabs)
    stock-entry.tsx    - Stock entry form
    stock-register.tsx - Stock register view
    bidding.tsx        - Bidding interface
    transactions.tsx   - Transaction calculations (grouped by lot, hammali per bag, print receipts)
    cash.tsx           - Cash management
    farmer-ledger.tsx  - Farmer ledger (tabular view with summary cards, filters, edit/merge/archive)
    buyer-ledger.tsx   - Buyer ledger view
```

## Authentication
- Session-based auth with PostgreSQL session store
- System admin: username `admin`, password from ADMIN_PASSWORD env secret (synced on startup)
- New users: default password `password123`, must change on first login
- Change password requires registered mobile number verification
- Business status (active/inactive/archived) checked on every request
- Inactive/archived business blocks user login and ongoing sessions

## Mobile-First Design
- Bottom navigation on mobile/tablet (< 768px)
- Desktop sidebar with collapse toggle
- 44px minimum touch targets
- Touch-optimized forms with proper input modes (numeric, decimal, tel)

## Database
- PostgreSQL with Drizzle ORM
- Schema push: `npm run db:push`
- Tables: businesses, users, farmers, farmer_edit_history, buyers, buyer_edit_history, lots, bids, transactions, cash_entries
- Farmer fields: farmerId (auto-generated FM+YYYYMMDD+seq, unique per business), name, phone, village, tehsil, district, state, openingBalance, negativeFlag, isArchived
- Business fields: merchantId (unique), name, phone, address, status (active/inactive/archived)
- User fields: username, name, phone, password, businessId, role (system_admin/user), mustChangePassword
- Buyer fields: buyerId (auto-generated BY+YYYYMMDD+seq), name, phone, address, buyerCode, negativeFlag, isActive, openingBalance
- Lot fields: lotId (auto POT/ONI/GAR+YYYYMMDD+seq), crop, variety, numberOfBags, size, bagMarka, vehicleNumber, vehicleBhadaRate, initialTotalWeight
- BuyerEditHistory: tracks field changes with old/new values, changedBy, timestamp
- Transaction fields: includes hammaliPerBag (per-bag rate), hammaliCharges (total = perBag Ã— bags), chargedTo (Buyer/Seller)
- Transactions grouped by lot: pending bids and completed transactions are grouped by lot
- Print receipts: Farmer Receipt in Hindi, Buyer Receipt in English (opens in print window)

## Running
- `npm run dev` starts both Express backend and Vite frontend on port 5000

## Districts Supported
Agar Malwa, Dewas, Dhar, Indore, Jhabua, Khargoan, Mandsaur, Neemuch, Rajgarh, Ratlam, Sagar, Shajapur, Ujjain

## Crops Supported
Garlic, Onion, Potato

## Environment Secrets
- **ADMIN_PASSWORD**: Admin login password (synced to DB on each server start)
- **RESET_PASSWORD**: Separate password required for data reset actions (compared directly from env, not stored in DB)
- **SESSION_SECRET**: Session encryption key

## Admin Actions
- **Toggle Status**: Activate/deactivate business (requires admin password)
- **Archive**: Archive/reinstate business (requires admin password)
- **Reset**: Wipe all user-entered data for a business (requires admin password + RESET_PASSWORD from env)
- **Reset User Password**: Reset user password to default (password123)
- **Delete User**: Remove user account (cannot delete system admin)
